pipeline {
  agent any

  environment {
    REGISTRY = "ghcr.io"
    IMAGE_NAME = "i-omsharma/decision-control-plane"
    KUBECONFIG_CRED = "kubeconfig-prod"
    GHCR_CRED = "ghcr-token"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Test') {
      agent {
        docker {
          image 'node:22-alpine'
          args '-u root'
        }
      }
      steps {
        sh 'npm ci'
        sh 'npm test --if-present'
        sh '''
          node -e "
          import yaml from 'js-yaml';
          import fs from 'fs';
          const config = yaml.load(fs.readFileSync('./config/rules.yaml','utf8'));
          console.log('Rules loaded:', config.rules.length);
          "
        '''
      }
    }

    stage('Build Docker Image') {
      steps {
        script {
          def version = sh(
            script: 'git describe --tags --always',
            returnStdout: true
          ).trim()

          env.IMAGE_TAG = version
        }

        sh """
          docker build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG .
        """
      }
    }

    stage('Push to GHCR') {
      steps {
        withCredentials([string(credentialsId: GHCR_CRED, variable: 'GHCR_TOKEN')]) {
          sh '''
            echo $GHCR_TOKEN | docker login ghcr.io -u i-omsharma --password-stdin
            docker push $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
          '''
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        withCredentials([file(credentialsId: KUBECONFIG_CRED, variable: 'KUBECONFIG')]) {
          sh '''
            sed -i "s|image: .*|image: $REGISTRY/$IMAGE_NAME:$IMAGE_TAG|" k8s/deployment-v1.yaml
            kubectl apply -f k8s/deployment-v1.yaml
            kubectl rollout status deployment/decision-platform-v1 -n decision-platform
          '''
        }
      }
    }
  }

  post {
    failure {
      echo "❌ Pipeline failed"
    }
    success {
      echo "✅ Deployment successful"
    }
  }
}
